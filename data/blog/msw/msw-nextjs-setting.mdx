---
title: '[Nextjs] Nextjs14에서 MSW2.0 사용해보자'
date: '2023-12-11'
tags: ['Nextjs', 'msw', 'mocking']
draft: false
summary: Nextjs에서 MSW로 mocking하기
---

## MSW 설치

```bash
npm install -D msw
```

## Service worker 등록

https://mswjs.io/docs/integrations/browser#copy-the-worker-script

```bash
npx msw init /public
```

## Worker 설정하기

https://mswjs.io/docs/integrations/browser#setup

```typescript:/src/mocks/browser.ts
import { setupWorker } from "msw/browser";
import { handlers } from "./user/handlers";

export const worker = setupWorker(...handlers);

```

```typescript:/src/mocks/user/handlers.ts
import { HttpResponse, http } from "msw";
export const handlers = [
  http.get("https://jsonplaceholder.typicode.com/users", () => {
    return HttpResponse.json([
      { id: 1, name: "Tom", username: "user1", email: "user1@test.com" },
      { id: 2, name: "Jerry", username: "user2", email: "user2@test.com" },
      { id: 3, name: "Smith", username: "user3", email: "user3@test.com" },
      { id: 4, name: "Alex", username: "user4", email: "user4@test.com" },
    ]);
  }),
];
```

## Worker 시작하기

https://mswjs.io/docs/integrations/browser#conditionally-enable-mocking

공식문서를 읽어보면 woker를 환경에 따라 조건부로 실행하고 앱에서 발생하는 요청보다 먼저 실행하라고 되어있다.

React 예제가 나오는데 render를 callback으로 호출하고 있다.

환경 변수를 등록해준다.

```plain:.env.local
NEXT_PUBLIC_API_MOCKING=enabled
```

Nextjs에서는 rendering전에 작업을 추가할 수 없기 때문에 layout.tsx에서 worker.start()를 해준다.

```typescript:/src/app/layout.tsx

...

async function enableMocking() {
  if (process.env.NODE_ENV !== "development") {
    return;
  }

  const { worker } = await import("@/mocks/browser");

  return worker.start();
}

enableMocking();

...

```

layout.tsx은 서버 컴포넌트라 worker를 실행할 수 없다.
worker를 실행하는 부분을 wrapper로 만들어준다.

```typescript:/src/mocks/MswInitializer.tsx

"use client";
import { PropsWithChildren, useEffect, useState } from "react";

type TMswWrapperProps = PropsWithChildren;
export const MswWrapper = ({ children }: TMswWrapperProps) => {
  const isMockingMode = process.env.NEXT_PUBLIC_API_MOCKING === "enabled";
  const [mswReady, setMswReady] = useState(!isMockingMode);
  useEffect(() => {
    async function initWorker() {
      if (typeof window !== "undefined") {
        const { worker } = await import("@/mocks/browser");
        await worker.start();
        setMswReady((_) => true);
      }
    }
    if (!mswReady) initWorker();
  }, [mswReady]);

  if (!mswReady) return null;
  return <>{children}</>;
};


```

wrapper를 만들고 layout.tsx에서 children을 감싸준다.

```typescript:/src/app/page.tsx
import type { Metadata } from "next";
import { Inter } from "next/font/google";
import "./globals.css";
import { MswWrapper } from "@/mocks/MswWrapper";

const inter = Inter({ subsets: ["latin"] });

export const metadata: Metadata = {
  title: "Create Next App",
  description: "Generated by create next app",
};

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="en">
      <body className={inter.className}>
        <MswWrapper>{children}</MswWrapper>
      </body>
    </html>
  );
}
```

## 결과

![231211-035130](/static/images/msw-nextjs-setting/231211-035130.png)

## Reference

https://jaypedia.tistory.com/382
https://github.com/mswjs/msw/issues/1801
